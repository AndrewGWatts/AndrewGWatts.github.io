<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Content CMS â€” admin.html</title>
  <!-- TailwindCSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Font Awesome (for previews) -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha512-IvX9QXbOamc0p0lN7d9Uu2wqJ2y1m6m4zCq+o0xJmZ2e6L3C6o6p84wk3ROH8kHg7S5nZK0h0H8O9nH0s2C5QA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <style>
    /* nicer scrollbars */
    * { scrollbar-width: thin; }
    .card { @apply rounded-2xl shadow-lg bg-white; }
    .btn { @apply inline-flex items-center gap-2 rounded-xl px-3 py-2 text-sm font-medium shadow-sm border; }
    .btn-primary { @apply bg-indigo-600 text-white border-indigo-600 hover:bg-indigo-700; }
    .btn-subtle { @apply bg-white text-gray-700 hover:bg-gray-50; }
    .field { @apply grid gap-1; }
    .label { @apply text-sm font-semibold text-gray-700; }
    .help { @apply text-xs text-gray-500; }
    .input, .textarea, .select { @apply w-full rounded-lg border px-3 py-2; }
    .textarea { @apply min-h-[90px]; }
    .section-title { @apply text-lg font-bold text-gray-900 mb-3; }
    .pill { @apply text-xs px-2 py-1 rounded-full bg-gray-100 border; }
    .icon-preview i { font-size: 20px; }
    .drag { cursor: grab; }
    details > summary { list-style: none; }
    details > summary::-webkit-details-marker { display:none; }
  </style>
</head>
<body class="bg-gray-100 min-h-screen">
  <div class="sticky top-0 z-40 bg-white/80 backdrop-blur supports-[backdrop-filter]:bg-white/60 border-b">
    <div class="max-w-7xl mx-auto px-4 py-3 flex flex-wrap items-center gap-2">
      <h1 class="text-xl font-bold">Content CMS</h1>
      <span class="pill">admin.html</span>
      <div class="ml-auto flex flex-wrap gap-2">
        <button id="btnLoadFromModule" class="btn btn-subtle" title="Load current ./data.js (module import)"><i class="fa-solid fa-plug"></i> Load data.js</button>
        <label class="btn btn-subtle cursor-pointer" title="Open a local data.js or JSON">
          <input id="fileInput" type="file" accept=".js,.json" class="hidden" />
          <i class="fa-solid fa-file-import"></i> Import file
        </label>
        <button id="btnSaveJS" class="btn btn-primary" title="Download as data.js"><i class="fa-solid fa-download"></i> Download data.js</button>
        <button id="btnSaveJSON" class="btn btn-subtle" title="Download as JSON"><i class="fa-solid fa-file-code"></i> Download JSON</button>
        <button id="btnReset" class="btn btn-subtle" title="Reset to last loaded"><i class="fa-solid fa-rotate-left"></i> Reset</button>
      </div>
    </div>
  </div>

  <main class="max-w-7xl mx-auto px-4 py-6 grid grid-cols-1 lg:grid-cols-3 gap-6">
    <aside class="card p-4 lg:col-span-1 h-fit sticky top-[68px] self-start">
      <h2 class="section-title">Navigator</h2>
      <nav id="nav" class="grid gap-1 text-sm"></nav>
      <div class="mt-4 grid gap-2">
        <label class="field">
          <span class="label">Quick search fields</span>
          <input id="quickSearch" class="input" placeholder="Type to filter visible inputs by label..."/>
        </label>
        <label class="field">
          <span class="label">Icon Picker (global)</span>
          <input id="iconSearch" class="input" placeholder="Search Font Awesome icons..." />
          <div class="help">Click an icon to copy its class. Paste into any <code>icon</code> or <code>iconClass</code> field. Live preview below.</div>
          <div id="iconResults" class="mt-2 grid grid-cols-8 sm:grid-cols-10 md:grid-cols-12 gap-2 max-h-64 overflow-auto border rounded-lg p-2 bg-gray-50"></div>
        </label>
      </div>
    </aside>

    <section id="forms" class="lg:col-span-2 grid gap-6"></section>
  </main>

  <template id="tpl-item-controls">
    <div class="flex items-center gap-2">
      <button class="btn btn-subtle btn-up" title="Move up"><i class="fa-solid fa-arrow-up"></i></button>
      <button class="btn btn-subtle btn-down" title="Move down"><i class="fa-solid fa-arrow-down"></i></button>
      <button class="btn btn-subtle btn-dup" title="Duplicate"><i class="fa-regular fa-clone"></i></button>
      <button class="btn btn-subtle btn-del" title="Delete"><i class="fa-solid fa-trash"></i></button>
    </div>
  </template>

  <script type="module">
    // ---- State ----
    let STATE = {
      siteContent: {},
      sectionsData: {},
      webAppsData: [],
      servicesData: [],
      promptsData: [],
      webDesignData: [],
      __loadedSnapshot: null,
    };

    const $ = (sel, el=document) => el.querySelector(sel);
    const $$ = (sel, el=document) => Array.from(el.querySelectorAll(sel));

    // ---- Utility: deep clone ----
    const deepClone = (obj) => JSON.parse(JSON.stringify(obj));

    // ---- Utility: download helpers ----
    function download(filename, text) {
      const blob = new Blob([text], {type: 'text/plain'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = filename; a.click();
      setTimeout(()=>URL.revokeObjectURL(url), 5000);
    }

    function toDataJS(state) {
      const header = `// Generated by admin.html on ${new Date().toISOString()}\n`;
      return header +
`export const siteContent = ${JSON.stringify(state.siteContent, null, 4)};\n\n`+
`export const sectionsData = ${JSON.stringify(state.sectionsData, null, 4)};\n\n`+
`export const webAppsData = ${JSON.stringify(state.webAppsData, null, 4)};\n\n`+
`export const servicesData = ${JSON.stringify(state.servicesData, null, 4)};\n\n`+
`export const promptsData = ${JSON.stringify(state.promptsData, null, 4)};\n\n`+
`export const webDesignData = ${JSON.stringify(state.webDesignData, null, 4)};\n`;
    }

    function toJSON(state) {
      return JSON.stringify({
        siteContent: state.siteContent,
        sectionsData: state.sectionsData,
        webAppsData: state.webAppsData,
        servicesData: state.servicesData,
        promptsData: state.promptsData,
        webDesignData: state.webDesignData,
      }, null, 2);
    }

    // ---- Loaders ----
    async function loadFromModule() {
      try {
        const mod = await import('./data.js?_=' + Date.now());
        const loaded = {
          siteContent: mod.siteContent ?? {},
          sectionsData: mod.sectionsData ?? {},
          webAppsData: mod.webAppsData ?? [],
          servicesData: mod.servicesData ?? [],
          promptsData: mod.promptsData ?? [],
          webDesignData: mod.webDesignData ?? [],
        };
        setState(loaded, true);
      } catch (e) {
        alert('Could not import ./data.js. Make sure admin.html sits beside data.js.\n\n' + e);
      }
    }

    async function loadFromFile(file) {
      const text = await file.text();
      let obj;
      if (file.name.endsWith('.json')) {
        obj = JSON.parse(text);
      } else if (file.name.endsWith('.js')) {
        // Try to parse an ES module by evaluating export lines.
        // Create a blob module and import it.
        const blob = new Blob([text], { type: 'text/javascript' });
        const url = URL.createObjectURL(blob);
        try {
          const mod = await import(url + '?_=' + Date.now());
          obj = {
            siteContent: mod.siteContent,
            sectionsData: mod.sectionsData,
            webAppsData: mod.webAppsData,
            servicesData: mod.servicesData,
            promptsData: mod.promptsData,
            webDesignData: mod.webDesignData,
          };
        } finally {
          URL.revokeObjectURL(url);
        }
      }
      if (!obj) throw new Error('Unrecognized file');
      setState(obj, true);
    }

    function setState(newState, snapshot=false) {
      STATE = {
        siteContent: deepClone(newState.siteContent || {}),
        sectionsData: deepClone(newState.sectionsData || {}),
        webAppsData: deepClone(newState.webAppsData || []),
        servicesData: deepClone(newState.servicesData || []),
        promptsData: deepClone(newState.promptsData || []),
        webDesignData: deepClone(newState.webDesignData || []),
        __loadedSnapshot: snapshot ? deepClone(newState) : STATE.__loadedSnapshot,
      };
      renderAll();
      localStorage.setItem('cms.autosave', toJSON(STATE));
    }

    // ---- Autosave restore ----
    (function restore() {
      const raw = localStorage.getItem('cms.autosave');
      if (raw) {
        try { setState(JSON.parse(raw)); } catch {}
      }
    })();

    // ---- Icon Picker (global) ----
    let ICONS = [];
    async function initIcons() {
      // Try to fetch FA metadata (6.x). Fallback to a small built-in set if offline.
      try {
        const res = await fetch('https://unpkg.com/@fortawesome/fontawesome-free@6.5.2/metadata/icons.json');
        const data = await res.json();
        ICONS = Object.keys(data).flatMap(name => {
          const styles = data[name]?.styles || [];
          return styles.map(s => ({
            class: (s === 'brands' ? 'fab' : 'fa-' + s) + ' fa-' + name,
            name,
            style: s
          }));
        });
      } catch (e) {
        ICONS = [
          'fas fa-user','fas fa-link','fas fa-envelope','fas fa-code','fas fa-gamepad','fas fa-rocket','fas fa-brain','fas fa-clock','fas fa-store','fas fa-laptop-code','fab fa-github','fab fa-linkedin','fab fa-twitter','fab fa-discord','fab fa-youtube','fab fa-facebook'
        ].map(cls => ({class: cls, name: cls.split(' ').at(-1).replace('fa-',''), style: cls.startsWith('fab')?'brands':'solid'}));
      }
      renderIconSearch('');
    }

    function renderIconSearch(q) {
      const box = $('#iconResults');
      box.innerHTML = '';
      const needle = (q||'').trim().toLowerCase();
      const results = ICONS.filter(i => i.name.includes(needle) || i.class.includes(needle)).slice(0, 400);
      for (const ico of results) {
        const btn = document.createElement('button');
        btn.className = 'p-2 rounded-lg bg-white border hover:bg-gray-50 text-center';
        btn.title = ico.class;
        btn.innerHTML = `<div class="icon-preview"><i class="${ico.class}"></i></div><div class="text-[10px] truncate mt-1">${ico.name}</div>`;
        btn.onclick = () => {
          navigator.clipboard.writeText(ico.class);
          btn.classList.add('ring-2','ring-indigo-500');
          setTimeout(()=>btn.classList.remove('ring-2','ring-indigo-500'), 600);
        };
        box.appendChild(btn);
      }
    }

    $('#iconSearch').addEventListener('input', e => renderIconSearch(e.target.value));

    // ---- Quick filter of fields ----
    $('#quickSearch').addEventListener('input', (e)=>{
      const q = e.target.value.toLowerCase();
      $$('#forms [data-label]').forEach(node => {
        const hit = node.getAttribute('data-label').toLowerCase().includes(q);
        node.style.display = hit ? '' : 'none';
      });
    });

    // ---- Rendering ----
    function renderAll() {
      renderNav();
      const root = $('#forms');
      root.innerHTML = '';
      root.append(
        section_SiteContent(),
        section_SectionsData(),
        section_Array('Web Apps', 'webAppsData', render_WebAppItem, newWebApp),
        section_Array('Web Design', 'webDesignData', render_WebDesignItem, newWebDesign),
        section_Array('Services', 'servicesData', render_ServiceItem, newService),
        section_Array('Prompts', 'promptsData', render_PromptItem, newPrompt),
        section_CV()
      );
      setupImagePreviews(root);
    }

    function renderNav() {
      const nav = $('#nav');
      nav.innerHTML = '';
      const links = [
        ['Site Content', '#sec-site'],
        ['Sections/Titles', '#sec-sections'],
        ['Web Apps', '#sec-webapps'],
        ['Web Design', '#sec-webdesign'],
        ['Services', '#sec-services'],
        ['Prompts', '#sec-prompts'],
        ['CV', '#sec-cv']
      ];
      for (const [label, href] of links) {
        const a = document.createElement('a');
        a.className = 'px-3 py-2 rounded-lg hover:bg-gray-100 flex items-center justify-between';
        a.href = href; a.textContent = label;
        nav.appendChild(a);
      }
    }

    // ---- Basic field builders ----
    function field(label, value, onInput, opts={}) {
      const wrap = document.createElement('div');
      wrap.className = 'field';
      wrap.setAttribute('data-label', label);
      const id = 'f_' + Math.random().toString(36).slice(2);
      const inputType = opts.type || 'text';

      const labelEl = document.createElement('label');
      labelEl.className = 'label';
      labelEl.textContent = label;

      let ctrl;
      if (inputType === 'textarea') {
        ctrl = document.createElement('textarea');
        ctrl.className = 'textarea';
        ctrl.value = value || '';
        ctrl.addEventListener('input', () => onInput(ctrl.value));
      } else if (inputType === 'select' && opts.options) {
        ctrl = document.createElement('select');
        ctrl.className = 'select';
        for (const [val, text] of opts.options) {
          const o = document.createElement('option');
          o.value = val; o.textContent = text; ctrl.appendChild(o);
        }
        ctrl.value = value || opts.options?.[0]?.[0] || '';
        ctrl.addEventListener('change', () => onInput(ctrl.value));
      } else {
        ctrl = document.createElement('input');
        ctrl.className = 'input';
        ctrl.type = inputType;
        ctrl.value = value ?? '';
        ctrl.addEventListener('input', () => onInput(ctrl.value));
      }

      if (opts.help) {
        const help = document.createElement('div');
        help.className = 'help';
        help.innerHTML = opts.help;
        wrap.append(labelEl, ctrl, help);
      } else {
        wrap.append(labelEl, ctrl);
      }

      if (/icon/i.test(label)) {
        // Live icon preview
        const prev = document.createElement('div');
        prev.className = 'icon-preview mt-1 text-gray-700';
        prev.innerHTML = `<i class="${value||''}"></i> <code class="text-xs">${value||''}</code>`;
        wrap.appendChild(prev);
        ctrl.addEventListener('input',()=>{
          prev.innerHTML = `<i class="${ctrl.value}"></i> <code class="text-xs">${ctrl.value}</code>`;
        });
      }

      if (/img|picture|src/i.test(label)) {
        // Live image preview
        const prev = document.createElement('img');
        prev.className = 'mt-2 max-h-28 rounded-lg border bg-white object-cover';
        prev.src = value || '';
        prev.onerror = () => prev.classList.add('hidden');
        prev.onload = () => prev.classList.remove('hidden');
        wrap.appendChild(prev);
        ctrl.addEventListener('input',()=>{ prev.src = ctrl.value; });
      }

      return wrap;
    }

    function keyValRow(obj, idx, keySpec, remove, moveUp, moveDown, duplicate) {
      const row = document.createElement('div');
      row.className = 'grid md:grid-cols-[1fr_2fr_auto] gap-3 items-end p-3 border rounded-xl bg-gray-50';

      const keyField = field(keySpec.keyLabel, obj[keySpec.key] || '', (v)=>obj[keySpec.key]=v);
      const valField = field(keySpec.valLabel, obj[keySpec.val] || '', (v)=>obj[keySpec.val]=v);

      const controls = document.importNode($('#tpl-item-controls').content, true);
      controls.querySelector('.btn-del').onclick = remove;
      controls.querySelector('.btn-up').onclick = moveUp;
      controls.querySelector('.btn-down').onclick = moveDown;
      controls.querySelector('.btn-dup').onclick = duplicate;

      row.append(keyField, valField, controls);
      return row;
    }

    function listEditor(title, arr, renderItem, createNew) {
      const sec = document.createElement('section');
      sec.className = 'card p-4';
      sec.innerHTML = `<h3 class="section-title">${title}</h3>`;

      const list = document.createElement('div');
      list.className = 'grid gap-4';
      sec.appendChild(list);

      function refresh() {
        list.innerHTML = '';
        arr.forEach((item, idx) => {
          const wrap = document.createElement('div');
          wrap.className = 'grid gap-3 p-3 border rounded-xl';
          const head = document.createElement('div');
          head.className = 'flex items-center justify-between gap-3';
          const title = document.createElement('div');
          title.className = 'font-semibold truncate';
          title.textContent = renderItem.title?.(item, idx) || `Item ${idx+1}`;
          const ctrls = document.importNode($('#tpl-item-controls').content, true);
          ctrls.querySelector('.btn-del').onclick = ()=>{ arr.splice(idx,1); refresh(); saveAutosave(); };
          ctrls.querySelector('.btn-up').onclick = ()=>{ if (idx>0) { [arr[idx-1],arr[idx]]=[arr[idx],arr[idx-1]]; refresh(); saveAutosave(); } };
          ctrls.querySelector('.btn-down').onclick = ()=>{ if (idx<arr.length-1) { [arr[idx+1],arr[idx]]=[arr[idx],arr[idx+1]]; refresh(); saveAutosave(); } };
          ctrls.querySelector('.btn-dup').onclick = ()=>{ arr.splice(idx+1,0,deepClone(item)); refresh(); saveAutosave(); };
          head.append(title, ctrls);
          wrap.appendChild(head);

          const inner = renderItem.body(item, idx);
          wrap.appendChild(inner);
          list.appendChild(wrap);
        });
      }

      const addBtn = document.createElement('button');
      addBtn.className = 'btn btn-subtle mt-2';
      addBtn.innerHTML = '<i class="fa-solid fa-plus"></i> Add item';
      addBtn.onclick = ()=>{ arr.push(createNew()); refresh(); saveAutosave(); };
      sec.appendChild(addBtn);

      refresh();
      return sec;
    }

    function saveAutosave(){
      localStorage.setItem('cms.autosave', toJSON(STATE));
    }

    function setupImagePreviews(root){
      // already handled in field(); kept for extension hooks
    }

    // ---- Sections ----
    function section_SiteContent(){
      const s = STATE.siteContent;
      const sec = document.createElement('section');
      sec.className = 'card p-4';
      sec.id = 'sec-site';
      sec.innerHTML = '<h3 class="section-title">Site Content</h3>';
      const grid = document.createElement('div');
      grid.className = 'grid md:grid-cols-2 gap-4';
      grid.append(
        field('siteTitle', s.siteTitle, v=>{s.siteTitle=v; saveAutosave();}),
        field('name', s.name, v=>{s.name=v; saveAutosave();}),
        field('profilePicture', s.profilePicture, v=>{s.profilePicture=v; saveAutosave();}, {help:'URL to your avatar or image.'})
      );

      // Social Links
      const social = listEditor('Social Links', s.socialLinks = s.socialLinks || [], {
        title: (it)=> it.label || it.url || 'Social',
        body: (it, idx)=>{
          const b = document.createElement('div');
          b.className = 'grid md:grid-cols-2 gap-3';
          b.append(
            field('url', it.url, v=>{it.url=v; saveAutosave();}),
            field('label', it.label, v=>{it.label=v; saveAutosave();}),
            field('icon', it.icon, v=>{it.icon=v; saveAutosave();}, {help:'Use the Icon Picker or paste a FA class, e.g., <code>fab fa-github</code>'})
          );
          return b;
        }
      }, ()=>({url:'', icon:'fas fa-link', label:''}));

      // Nav Links
      const nav = listEditor('Nav Links', s.navLinks = s.navLinks || [], {
        title: it=> it.text || it.href,
        body: (it)=>{
          const b = document.createElement('div');
          b.className = 'grid md:grid-cols-2 gap-3';
          b.append(
            field('text', it.text, v=>{it.text=v; saveAutosave();}),
            field('href', it.href, v=>{it.href=v; saveAutosave();})
          );
          return b;
        }
      }, ()=>({text:'', href:'#'}));

      // About Me
      const aboutWrap = document.createElement('div');
      aboutWrap.className = 'grid md:grid-cols-2 gap-4';
      const about = s.aboutMe = s.aboutMe || {};
      aboutWrap.append(
        field('aboutMe.title', about.title, v=>{about.title=v; saveAutosave();}),
        field('aboutMe.intro', about.intro, v=>{about.intro=v; saveAutosave();}, {type:'textarea'})
      );

      // Skills (grouped)
      const skills = s.skills = s.skills || {};
      const skillsWrap = document.createElement('div');
      skillsWrap.className = 'grid md:grid-cols-2 gap-4';
      skillsWrap.append(
        field('skills.languagesTitle', skills.languagesTitle, v=>{skills.languagesTitle=v; saveAutosave();}),
        field('skills.languages', skills.languages, v=>{skills.languages=v; saveAutosave();}, {type:'textarea'}),
        field('skills.librariesTitle', skills.librariesTitle, v=>{skills.librariesTitle=v; saveAutosave();}),
        field('skills.libraries', skills.libraries, v=>{skills.libraries=v; saveAutosave();}, {type:'textarea'}),
        field('skills.aiToolsTitle', skills.aiToolsTitle, v=>{skills.aiToolsTitle=v; saveAutosave();}),
        field('skills.aiTools', skills.aiTools, v=>{skills.aiTools=v; saveAutosave();}, {type:'textarea'}),
        field('skills.toolsPlatformsTitle', skills.toolsPlatformsTitle, v=>{skills.toolsPlatformsTitle=v; saveAutosave();}),
        field('skills.toolsPlatforms', skills.toolsPlatforms, v=>{skills.toolsPlatforms=v; saveAutosave();}, {type:'textarea'})
      );

      // Contact & Footer
      const contact = s.contact = s.contact || {};
      const footer = s.footer = s.footer || {};
      const contactWrap = document.createElement('div');
      contactWrap.className = 'grid md:grid-cols-2 gap-4';
      contactWrap.append(
        field('contact.email', contact.email, v=>{contact.email=v; saveAutosave();}),
        field('contact.linkedin.text', contact.linkedin?.text || '', v=>{ (contact.linkedin ||= {}).text = v; saveAutosave(); }),
        field('contact.linkedin.url', contact.linkedin?.url || '', v=>{ (contact.linkedin ||= {}).url = v; saveAutosave(); }),
        field('contact.github.text', contact.github?.text || '', v=>{ (contact.github ||= {}).text = v; saveAutosave(); }),
        field('contact.github.url', contact.github?.url || '', v=>{ (contact.github ||= {}).url = v; saveAutosave(); }),
        field('footer.copyright', footer.copyright, v=>{footer.copyright=v; saveAutosave();})
      );

      sec.append(
        grid,
        social,
        nav,
        document.createElement('hr'),
        makeSubSection('About Me', aboutWrap),
        makeSubSection('Skills', skillsWrap),
        makeSubSection('Contact & Footer', contactWrap)
      );
      return sec;
    }

    function makeSubSection(title, body){
      const box = document.createElement('div');
      box.className = 'mt-2';
      const h = document.createElement('h4');
      h.className = 'font-semibold text-gray-900 mb-2'; h.textContent = title;
      box.append(h, body);
      return box;
    }

    function section_SectionsData(){
      const s = STATE.sectionsData;
      const sec = document.createElement('section');
      sec.className = 'card p-4';
      sec.id = 'sec-sections';
      sec.innerHTML = '<h3 class="section-title">Sections / Title Strings</h3>';
      const grid = document.createElement('div');
      grid.className = 'grid md:grid-cols-2 gap-4';
      for (const k of ['featuredSectionOne','featuredSectionTwo','listTitle','textcardTitle','listTitle2','contactTitle']){
        grid.append(field(k, s[k]||'', v=>{s[k]=v; saveAutosave();}));
      }
      sec.append(grid);
      return sec;
    }

    // ---- Array section factories ----
    function newWebApp(){
      return { imgSrc:'', imgAlt:'', iconClass:'fas fa-code', title:'', description:'', techTags:[], links:[] };
    }
    function render_WebAppItem(){
      return {
        title: it => it.title || it.imgAlt || 'Web App',
        body: (it)=>{
          const b = document.createElement('div');
          b.className = 'grid gap-3';
          const g = document.createElement('div');
          g.className = 'grid md:grid-cols-2 gap-3';
          g.append(
            field('imgSrc', it.imgSrc, v=>{it.imgSrc=v; saveAutosave();}),
            field('imgAlt', it.imgAlt, v=>{it.imgAlt=v; saveAutosave();}),
            field('iconClass', it.iconClass, v=>{it.iconClass=v; saveAutosave();}),
            field('title', it.title, v=>{it.title=v; saveAutosave();}),
            field('description', it.description, v=>{it.description=v; saveAutosave();}, {type:'textarea'})
          );
          b.appendChild(g);
          b.append(tagEditor('techTags', it.techTags = it.techTags || []));
          b.append(linkListEditor(it.links = it.links || []));
          return b;
        }
      };
    }

    function newWebDesign(){
      return { imgSrc:'', imgAlt:'', iconClass:'fas fa-laptop-code', title:'', description:'', techTags:[], links:[] };
    }
    function render_WebDesignItem(){
      return render_WebAppItem(); // same shape
    }

    function newService(){
      return { iconClass:'fas fa-code', title:'', description:'' };
    }
    function render_ServiceItem(){
      return {
        title: it=> it.title || 'Service',
        body: (it)=>{
          const b = document.createElement('div');
          b.className = 'grid md:grid-cols-2 gap-3';
          b.append(
            field('iconClass', it.iconClass, v=>{it.iconClass=v; saveAutosave();}),
            field('title', it.title, v=>{it.title=v; saveAutosave();}),
            field('description', it.description, v=>{it.description=v; saveAutosave();}, {type:'textarea'})
          );
          return b;
        }
      };
    }

    function newPrompt(){
      return { iconClass:'fas fa-star', title:'', description:'', links: [] };
    }
    function render_PromptItem(){
      return {
        title: it=> it.title || 'Prompt',
        body: (it)=>{
          const b = document.createElement('div');
          b.className = 'grid md:grid-cols-2 gap-3';
          b.append(
            field('iconClass', it.iconClass, v=>{it.iconClass=v; saveAutosave();}),
            field('title', it.title, v=>{it.title=v; saveAutosave();}),
            field('description', it.description, v=>{it.description=v; saveAutosave();}, {type:'textarea'})
          );
          b.append(linkListEditor(it.links = it.links || []));
          return b;
        }
      };
    }

    function linkListEditor(arr){
      const box = document.createElement('div');
      box.className = 'grid gap-2';
      const h = document.createElement('h5'); h.className='font-semibold'; h.textContent='Links';
      box.appendChild(h);

      function refresh(){
        // clear existing rows after header
        $$('.link-row', box).forEach(n=>n.remove());
        arr.forEach((link, idx)=>{
          const row = document.createElement('div');
          row.className = 'link-row grid md:grid-cols-[1fr_2fr_1fr_auto] gap-2 items-end p-2 border rounded-xl bg-gray-50';
          row.append(
            field('text', link.text, v=>{link.text=v; saveAutosave();}),
            field('url', link.url, v=>{link.url=v; saveAutosave();}),
            field('icon', link.icon, v=>{link.icon=v; saveAutosave();})
          );
          const ctrls = document.importNode($('#tpl-item-controls').content, true);
          ctrls.querySelector('.btn-del').onclick=()=>{arr.splice(idx,1); refresh(); saveAutosave();};
          ctrls.querySelector('.btn-up').onclick=()=>{ if (idx>0){ [arr[idx-1],arr[idx]]=[arr[idx],arr[idx-1]]; refresh(); saveAutosave(); } };
          ctrls.querySelector('.btn-down').onclick=()=>{ if (idx<arr.length-1){ [arr[idx+1],arr[idx]]=[arr[idx],arr[idx+1]]; refresh(); saveAutosave(); } };
          ctrls.querySelector('.btn-dup').onclick=()=>{ arr.splice(idx+1,0,deepClone(link)); refresh(); saveAutosave(); };
          row.appendChild(ctrls);
          box.appendChild(row);
        });
      }

      const add = document.createElement('button');
      add.className = 'btn btn-subtle w-fit';
      add.innerHTML = '<i class="fa-solid fa-plus"></i> Add link';
      add.onclick = ()=>{ arr.push({text:'', url:'', icon:''}); refresh(); saveAutosave(); };

      box.appendChild(add);
      refresh();
      return box;
    }

    function tagEditor(label, arr){
      const box = document.createElement('div');
      box.className = 'grid gap-2';
      const h = document.createElement('h5'); h.className='font-semibold'; h.textContent=label;
      const list = document.createElement('div');
      list.className = 'flex flex-wrap gap-2';

      const input = document.createElement('input');
      input.className = 'input'; input.placeholder = 'Add tag and press Enter';
      input.addEventListener('keydown', (e)=>{
        if (e.key==='Enter' && input.value.trim()){
          arr.push(input.value.trim()); input.value=''; render(); saveAutosave();
        }
      });

      function render(){
        list.innerHTML = '';
        arr.forEach((t, idx)=>{
          const tag = document.createElement('span');
          tag.className = 'pill flex items-center gap-1';
          tag.innerHTML = `<span>${t}</span>`;
          const x = document.createElement('button'); x.innerHTML='&times;'; x.className='ml-1 text-gray-500';
          x.onclick = ()=>{ arr.splice(idx,1); render(); saveAutosave(); };
          tag.appendChild(x);
          list.appendChild(tag);
        });
      }

      box.append(h, list, input);
      render();
      return box;
    }

    // ---- CV Section ----
    function section_CV(){
      const s = STATE.siteContent.cv = STATE.siteContent.cv || {};
      const sec = document.createElement('section');
      sec.className = 'card p-4';
      sec.id = 'sec-cv';
      sec.innerHTML = '<h3 class="section-title">CV</h3>';

      const grid = document.createElement('div');
      grid.className = 'grid md:grid-cols-2 gap-4';
      grid.append(
        field('cv.title', s.title || '', v=>{s.title=v; saveAutosave();}),
        field('cv.summaryTitle', s.summaryTitle || '', v=>{s.summaryTitle=v; saveAutosave();}),
        field('cv.summaryContent', s.summaryContent || '', v=>{s.summaryContent=v; saveAutosave();}, {type:'textarea'})
      );

      // Experience
      const exp = listEditor(s.experienceTitle || 'Experience', s.experience = s.experience || [], {
        title: it=> it.title || it.company || 'Role',
        body: (it)=>{
          const b = document.createElement('div');
          b.className = 'grid gap-3';
          const g = document.createElement('div'); g.className='grid md:grid-cols-3 gap-3';
          g.append(
            field('title', it.title, v=>{it.title=v; saveAutosave();}),
            field('company', it.company, v=>{it.company=v; saveAutosave();}),
            field('dates', it.dates, v=>{it.dates=v; saveAutosave();})
          );
          b.appendChild(g);

          // details list
          const details = it.details = it.details || [];
          const dl = document.createElement('div');
          dl.className = 'grid gap-2';
          const dh = document.createElement('h5'); dh.className='font-semibold'; dh.textContent='Details';
          const list = document.createElement('div'); list.className='grid gap-2';
          function refresh(){
            list.innerHTML='';
            details.forEach((d, idx)=>{
              const row = document.createElement('div');
              row.className = 'grid md:grid-cols-[1fr_auto] gap-2 items-start';
              row.append(
                field('detail', d, v=>{details[idx]=v; saveAutosave();}, {type:'textarea'})
              );
              const ctrls = document.importNode($('#tpl-item-controls').content, true);
              ctrls.querySelector('.btn-del').onclick=()=>{details.splice(idx,1); refresh(); saveAutosave();};
              ctrls.querySelector('.btn-up').onclick=()=>{ if (idx>0){ [details[idx-1],details[idx]]=[details[idx],details[idx-1]]; refresh(); saveAutosave(); } };
              ctrls.querySelector('.btn-down').onclick=()=>{ if (idx<details.length-1){ [details[idx+1],details[idx]]=[details[idx],details[idx+1]]; refresh(); saveAutosave(); } };
              ctrls.querySelector('.btn-dup').onclick=()=>{ details.splice(idx+1,0,details[idx]); refresh(); saveAutosave(); };
              row.appendChild(ctrls);
              list.appendChild(row);
            });
          }
          const add = document.createElement('button'); add.className='btn btn-subtle w-fit'; add.innerHTML='<i class="fa-solid fa-plus"></i> Add detail';
          add.onclick = ()=>{ details.push(''); refresh(); saveAutosave(); };
          dl.append(dh, list, add); refresh();
          b.append(dl);
          return b;
        }
      }, ()=>({title:'', company:'', dates:'', details:[]}));

      // Education
      const edu = listEditor(s.educationTitle || 'Education', s.education = s.education || [], {
        title: it=> it.degree || it.field || 'Education',
        body: (it)=>{
          const b = document.createElement('div'); b.className='grid md:grid-cols-2 gap-3';
          b.append(
            field('degree', it.degree, v=>{it.degree=v; saveAutosave();}),
            field('field', it.field, v=>{it.field=v; saveAutosave();}),
            field('university', it.university, v=>{it.university=v; saveAutosave();}),
            field('year', it.year, v=>{it.year=v; saveAutosave();})
          );
          return b;
        }
      }, ()=>({degree:'', field:'', university:'', year:''}));

      // Additional CV labels
      const extras = document.createElement('div');
      extras.className = 'grid md:grid-cols-2 gap-4';
      for (const k of ['experienceTitle','educationTitle','skillsTitle','educationalSkillsTitle','projectsTitle']){
        extras.append(field('cv.'+k, s[k]||'', v=>{s[k]=v; saveAutosave();}));
      }
      extras.append(
        field('cv.educationalSkills', s.educationalSkills || '', v=>{s.educationalSkills=v; saveAutosave();}, {type:'textarea'}),
        field('cv.projectsIntro', s.projectsIntro || '', v=>{s.projectsIntro=v; saveAutosave();}, {type:'textarea'}),
        field('cv.projectList (comma-separated)', (s.projectList||[]).join(', '), v=>{ s.projectList = v.split(',').map(x=>x.trim()).filter(Boolean); saveAutosave(); }, {type:'textarea'}),
        field('cv.awardsTitle', s.awardsTitle || '', v=>{s.awardsTitle=v; saveAutosave();}),
        field('cv.awardsContent', s.awardsContent || '', v=>{s.awardsContent=v; saveAutosave();}, {type:'textarea'})
      );

      sec.append(grid, exp, edu, makeSubSection('More CV labels & lists', extras));
      return sec;
    }

    // ---- Generic Array Section wrapper ----
    function section_Array(title, key, rendererFactory, makeNew){
      const arr = STATE[key] = STATE[key] || [];
      const def = rendererFactory();
      const sec = listEditor(title, arr, def, makeNew);
      sec.id = 'sec-' + key.replace(/Data$/,'');
      return sec;
    }

    // ---- Top bar actions ----
    $('#btnLoadFromModule').addEventListener('click', loadFromModule);
    $('#fileInput').addEventListener('change', (e)=>{
      const f = e.target.files?.[0]; if (f) loadFromFile(f);
      e.target.value='';
    });
    $('#btnSaveJS').addEventListener('click', ()=>{
      download('data.js', toDataJS(STATE));
    });
    $('#btnSaveJSON').addEventListener('click', ()=>{
      download('data.json', toJSON(STATE));
    });
    $('#btnReset').addEventListener('click', ()=>{
      if (!STATE.__loadedSnapshot) return alert('Nothing to reset to. Load data.js or import a file first.');
      setState(STATE.__loadedSnapshot, true);
    });

    // Init
    initIcons();
    renderAll();
  </script>
</body>
</html>
